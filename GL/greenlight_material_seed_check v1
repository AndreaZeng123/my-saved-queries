WITH
  set_RTE AS (
  SELECT
    sa.setId,
    ese.capacity_request_id AS VCR,
    ese.experiment_name,
    ese.experiment_id,
    ese.entryid,
    cre.homesite_name,
    sg.site_name,
    cr.crops,
    MAX(EXTRACT(Date
      FROM
        sa.audit_time_stamp)) AS RTE_date
  FROM
    `bcs-breeding-datasets.velocity.set_audits` sa
  LEFT JOIN
    `bcs-breeding-datasets.velocity.experiment_sets_entries` ese
  ON sa.setId = ese.setid
  JOIN UNNEST(ese.material_fulfillment_groups) AS material_fulfillment_groups
  LEFT JOIN `bcs-breeding-datasets.velocity.capacity_request` cr
  ON cr.capacity_request_id = ese.capacity_request_id
  LEFT JOIN UNNEST(cr.environment) cre
  LEFT JOIN `bcs-breeding-datasets.velocity.sets_geography` sg
  ON sg.entryid = ese.entryid
  WHERE
    1=1
    --AND sa.audit_status = 'Material Fulfillment: Ready to Execute'
    AND EXTRACT(DATE FROM sa.audit_time_stamp) >= '2024-07-31'
    AND material_fulfillment_groups = 'HAZELWOOD-SEED-CENTER'
  GROUP BY
    sa.setId,
    ese.capacity_request_id,
    ese.experiment_name,
    ese.experiment_id,
    ese.entryid,
    cre.homesite_name,
    sg.site_name,
    cr.crops),

  reqQuan AS (
  select 
  entryid,
  si.value AS requested_quantity
  from `bcs-breeding-datasets.velocity.experiment_sets_entries` ese
  JOIN UNNEST(ese.set_instructions) as si
  where 
  1=1
  and si.question_uom = 'SEEDS_PER_PACK'
  ),

  entry_barcode AS (
  SELECT es.entryid,CAST(mt.materialid AS numeric) AS barcode
  FROM `bcs-csw-core.velocity.sets`
  JOIN UNNEST(entries) es
  JOIN unnest(es.materials) mt
  where mt.producttype = 'inventory'
  ),

  entry_barcode_inv AS (
  SELECT
    eb.entryid,
    eb.barcode,
    inv.quantity,
    inv.uom    
  FROM
    entry_barcode eb
  JOIN
  `bcs-csw-core.velocity.inventory` inv
  ON 
  eb.barcode = inv.barcode
  ),


  combined AS (
  SELECT
    DISTINCT set_RTE.setId,
    set_RTE.VCR,
    set_RTE.experiment_name,
    set_RTE.experiment_id,
    set_RTE.RTE_date,
    set_RTE.entryId,    
    reqQuan.requested_quantity,
    entry_barcode_inv.barcode,
    entry_barcode_inv.quantity,
    entry_barcode_inv.uom
  FROM
    set_RTE
  LEFT JOIN 
    reqQuan
  ON set_RTE.entryid = reqQuan.entryid
  LEFT JOIN
    entry_barcode_inv
  ON
    set_RTE.entryid = entry_barcode_inv.entryid)


SELECT
  CAST(barcode AS numeric) AS inventory_vel_barcode,
  SUM(CAST(requested_quantity AS numeric)) AS requested_quantity,
  MIN(CAST(quantity AS numeric)) AS inventory_quantity,
  (MIN(CAST(quantity AS numeric)) - SUM(CAST(requested_quantity AS numeric))) AS seed_difference
FROM
  combined
GROUP BY
  1
ORDER BY
  seed_difference,barcode


